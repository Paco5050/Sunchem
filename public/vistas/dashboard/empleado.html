<!DOCTYPE html>
<html lang="es">

<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="">
  <meta name="author" content="">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <link rel="icon" href="data:,">

  <title>SunChemical</title>

  <!-- Bootstrap core CSS -->
  <link href="../../resources/css/bootstrap/bootstrap.min.css" rel="stylesheet">

  <!-- Custom styles for this template -->
  <link href="../../resources/css/dashboard/dashboard.css" rel="stylesheet">

  <style>
    .row div{
      margin-top:.5rem;
    }
  </style>
</head>

<body class="g-0">
  <br>
  <div class="container">
    <div class="row">
      <div class="col-lg-6">
        <h1 class="display-6">Administración de Empleados</h1>
      </div>
      <div class="col-lg-6">
        <img class="" src="../../resources/img/dashboard/crud_usuario.png" alt="" width="70px">
      </div>
    </div>
    <div class="row" id="tabla"></div>
  </div>

  <!-- Modal Crear-->
  <div class="modal fade col-lg-12 modal__empleados" id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
    aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="staticBackdropLabel">Registrar Empleado</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="RegistrarEmpleado">
            <div class="row">
              <div class="col-md-12">
                <label for="IdentidadEmpleado" class="form-label">Documento de identidad</label>
                <input id="IdentidadEmpleado" maxlength="255" type="number" class="form-control" required>
              </div>
              <div class="col-md-12 registro-completo">
                <label for="NombreEmpleado" class="form-label">Nombre</label>
                <input id="NombreEmpleado" type="text" maxlength="255" class="form-control" required>
              </div>
              <div class="col-md-12 registro-completo">
                <label for="ApellidoEmpleado" class="form-label">Apellido</label>
                <input id="ApellidoEmpleado" type="text" maxlength="255" class="form-control" required>
              </div>
              <div class="col-md-12 registro-completo">
                <label for="CorreoEmpleado" class="form-label">Correo</label>
                <input id="CorreoEmpleado" type="text" maxlength="255" class="form-control" required>
              </div>
              <div class="col-md-12 registro-completo">
                <label for="DireccionEmpleado" class="form-label">Dirección</label>
                <input id="DireccionEmpleado" maxlength="240" type="text" class="form-control" required>
              </div>
              <div class="col-md-12 registro-completo">
                <select name="ProfesionEmpleado" id="ProfesionEmpleado">
                  <option selected value="0" id="ProfesionSelected" >Seleccione alguna profesión</option>
                  <option value="-1" id="OtraProfesionEmpleado">otras</option>
                </select>
                <input type="text" id="OtraProfesionEmpleadoInput" placeholder="Ingrese otra profesión">
              </div>
              <div class="col-md-12 registro-completo">
                <select name="RolEmpleado" id="RolEmpleado">
                  <option selected value="0" >Seleccione un rol</option>
                  <option value="1">Administrador</option>
                  <option value="2">Básico</option>
                </select>
              </div>
              <hr class="mt-5 registro-completo d-none">
              <div class="col-md-12 registro-completo">
                <label for="UsuarioEmpleado" class="form-label">Usuario</strong></label>
                <input id="UsuarioEmpleado" type="text" class="form-control" required maxlength="255">
              </div>
              <div class="col-md-12 registro-completo" >
                <label for="ClaveEmpleado" class="form-label">Clave</label>
                <input id="ClaveEmpleado" type="password" class="form-control" required maxlength="255">
              </div>
              <div class="col-md-12 registro-completo ">
                <label for="PreguntaEmpleado" class="form-label">Pregunta <strong>(de seguridad) </strong></label>
                <input id="PreguntaEmpleado" type="text" class="form-control" required maxlength="240">
              </div>
              <div class="col-md-12 registro-completo">
                <label for="RespuestaEmpleado" class="form-label">Respuesta <strong>(de seguridad)</strong> </label>
                <input id="RespuestaEmpleado" type="password" class="form-control" required maxlength="240">
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" id="EmpleadoSubmit">Crear</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Actualizar-->
  <div class="modal fade col-lg-12" id="staticBackdrop3" data-bs-backdrop="static" data-bs-keyboard="false"
    tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="staticBackdropLabel">Actualizar Empleado</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form class="row g-3 needs-validation ms-2 mt-2" novalidate>

            <div class="row">
              <div class="col-md-12">
                <div class="col-md-12">
                  <label for="validationCustom01" class="form-label">Nombre Empleado</label>
                  <input type="text" class="form-control" value="" required>
                </div>
                <div class="col-md-12">
                  <label for="validationCustom01" class="form-label">Profesion</label>
                  <input type="text" class="form-control" value="" required>
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-md-12">
                <div class="col-md-12">
                  <label for="validationCustom01" class="form-label">Usuario</label>
                  <input type="text" class="form-control" value="" required>
                </div>
                <div class="col-md-12">
                  <label for="validationCustom01" class="form-label">Contraseña</label>
                  <input type="text" class="form-control" value="" required>
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-md-12">
                <label for="validationCustomUsername" class="form-label">Correo Empleado</label>
                <div class="input-group has-validation">
                  <span class="input-group-text" id="inputGroupPrepend">@</span>
                  <input type="text" class="form-control" aria-describedby="inputGroupPrepend" required>
                  <div class="invalid-feedback">
                    Please choose a username.
                  </div>
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-md-6">
                <label for="validationCustom04" class="form-label">Tipo Empleado</label>
                <select class="form-select" required>
                  <option selected disabled value="">Escoje...</option>
                  <option>...</option>
                </select>
                <div class="invalid-feedback">
                  Please select a valid state.
                </div>
              </div>
              <div class="col-md-6">
                <label for="validationCustom04" class="form-label">Estado Empleado</label>
                <select class="form-select" required>
                  <option selected disabled value="">Escoje...</option>
                  <option>...</option>
                </select>
                <div class="invalid-feedback">
                  Please select a valid state.
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-md-12">
                <label for="validationCustom04" class="form-label">Tipo Usuario</label>
                <select class="form-select" required>
                  <option selected disabled value="">Escoje...</option>
                  <option>...</option>
                </select>
                <div class="invalid-feedback">
                  Please select a valid state.
                </div>
              </div>
              <div class="col-md-12">
                <label for="validationCustom02" class="form-label">Dirección del Empleado</label>
                <textarea class="form-control" rows="3"></textarea>
                <div class="valid-feedback">
                  Looks good!
                </div>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-primary">Actualizar</button>
        </div>
      </div>
    </div>
  </div>
  <!-- JQUERY -->
  <script src="../../resources/js/efectos/jquery-3.4.1.js"></script>
  <!-- Bootstrap core JavaScript -->
  <script src="../../resources/js/bootstrap/bootstrap.bundle.min.js"></script>

  <!-- DATATABLES -->
  <script src="../../resources/js/efectos/jquery.dataTables.min.js"></script>
  <script src="../../resources/js/efectos/dataTables.bootstrap4.min.js"></script>
  <script src="../../resources/js/App/const/index.js"></script>
  <script src="../../resources/js/App/Ajax/index.js"></script>

  <script>
    const ProfesionSelected =  document.querySelector('#ProfesionSelected');
    ProfesionSelected.textContent = 'Cargando ... ';
    const SelectProfesion   = document.querySelector('#ProfesionEmpleado');
    const OtraProfesion     = document.querySelector('#OtraProfesionEmpleado');
    const OtraProfesionEmpleadoInput = document.querySelector('#OtraProfesionEmpleadoInput');

    const RegistrarEmpleadoForm = document.querySelector('#RegistrarEmpleado');
    const RolEmpleado = document.querySelector('#RolEmpleado');

    ajax({Uri:'Profesiones?api_token='+localStorage.token,
          Method:'GET',
          Request:null,
          CallBack:(res)=>{
            if(res.code == -1){
              ProfesionSelected.textContent = 'No se ha podido cargar la lista';
              return false;
            }
            res.data.forEach(Profesion => {
              const Profesiones = document.createElement('option');
              Profesiones.value = Profesion.id;
              Profesiones.textContent = Profesion.nombre;
              SelectProfesion.appendChild(Profesiones);
            });

            ProfesionSelected.textContent = 'Seleccionar profesión';
          }
    });

    SelectProfesion.addEventListener('input',(e)=>{
      if(e.target.value == -1){ // insertar nueva profesión
        OtraProfesionEmpleadoInput.readOnly = false;
      }else if(e.target.value > 0){
        OtraProfesionEmpleadoInput.readOnly = true;
        OtraProfesionEmpleadoInput.value = '';
      }
    })

    document.querySelector('#IdentidadEmpleado').addEventListener('input',e =>{

      if(!e.target.value){
        e.target.value = '';
        e.target.placeholder = 'por ejemplo: 11795545';
        alert('Ingresa una indentifación válida');
        return;
      }
    })

    RegistrarEmpleadoForm.onsubmit =  (e,req = null) => { // enviando datos
      event.preventDefault();

      const IdentidadEmpleado = document.querySelector('#IdentidadEmpleado');
      const NombreEmpleado    = document.querySelector('#NombreEmpleado');
      const ApellidoEmpleado  = document.querySelector('#ApellidoEmpleado');
      const CorreoEmpleado    = document.querySelector('#CorreoEmpleado');
      const DireccionEmpleado   = document.querySelector('#DireccionEmpleado');
      const UsuarioEmpleado   = document.querySelector('#UsuarioEmpleado');
      const ClaveEmpleado   = document.querySelector('#ClaveEmpleado');
      const PreguntaEmpleado   = document.querySelector('#PreguntaEmpleado');
      const RespuestaEmpleado   = document.querySelector('#RespuestaEmpleado');

      if(!IdentidadEmpleado.value){
        IdentidadEmpleado.placeholder = 'Por ejemplo: 1232465';
        alert("Escriba una identificación");
        return;
      }

      // registro de empleados
      ajax(
        {
          Uri:'ValidarEmpleado',
          Method:'POST',
          Request:{
            "api_token":localStorage.token,
            "documento_identidad" : IdentidadEmpleado.value.toLowerCase()
          },
          CallBack: res => {
            if(res.code == 2){ // si el empleado existe
              if(confirm(res.message + " , Desea recontratarle?")){
                ajax({
                  Uri:'RecontratarEmpleado/'+res.data.id+'?api_token='+localStorage.token,
                  Method:'PUT',
                  Request:null,
                  CallBack: res => {
                    if(res.code == 1){
                      alert(res.message);
                      location.reload();
                    }
                  }
                })
                return;
              }
              return;
            }

            if(document.querySelector('.registro-completo').classList.contains('d-none')){
                document.querySelectorAll('.registro-completo').forEach(item => {
                  item.classList.remove('d-none');
                })
                return;
            }

            if(
                !IdentidadEmpleado.value ||
                !NombreEmpleado.value ||
                !ApellidoEmpleado.value ||
                !CorreoEmpleado.value ||
                !DireccionEmpleado.value ||
                !UsuarioEmpleado.value||
                !ClaveEmpleado.value ||
                !PreguntaEmpleado.value ||
                !RespuestaEmpleado.value
              ){
                alert('Debe de ingresar todos los campos solicitados');
                return false;
              }

              if(!EMAIL_REGEX.test(CorreoEmpleado.value)){
                alert('Ingrese un correo válido');
                CorreoEmpleado.value = '';
                CorreoEmpleado.placeholder = 'usuario@dominio.com';
                return;
              }

              if(SelectProfesion.value == 0){
                alert('Debe seleccionar una profesión');
                return false;
              }
              if(RolEmpleado.value == 0){
                alert('Debe de seleccionar un rol');
                return false;
              }
              if(SelectProfesion.value == -1 && !OtraProfesionEmpleadoInput.value ){
                alert('Escriba la profesión');
                return;
              }

            ajax(
              {
                Uri:'ValidarCorreo',
                Method:'POST',
                Request:{
                  "api_token":localStorage.token,
                  "correo": CorreoEmpleado.value.toLowerCase()
                },
                CallBack: res => { // verificar disponibilidad del correo
                  if(res.code == 2){
                    alert("Correo en uso");
                    return;
                  }
                  ajax(
                    {
                      Uri:'ValidarUsuario',
                      Method:'POST',
                      Request:{
                        "api_token":localStorage.token,
                        "usuario":UsuarioEmpleado.value.toLowerCase()
                      },
                      CallBack : res => { // validar disponibilidad del usuario
                        if(res.code == 2){
                          alert("Usuario en uso");
                          return;
                        }
                        // registro valido

                        const req = {
                          Request : {
                            "api_token" : localStorage.token,
                            "usuario" : UsuarioEmpleado.value.toLowerCase(),
                            "clave" : ClaveEmpleado.value,
                            "correo" : CorreoEmpleado.value.toLowerCase(),
                            "pregunta" : PreguntaEmpleado.value.toLowerCase(),
                            "respuesta" : RespuestaEmpleado.value.toLowerCase(),
                            "nombre" : NombreEmpleado.value.toLowerCase(),
                            "apellido" : ApellidoEmpleado.value.toLowerCase(),
                            "direccion" : DireccionEmpleado.value.toLowerCase(),
                            "profesion_id" : SelectProfesion.value,
                            "documento_identidad" : IdentidadEmpleado.value.toLowerCase(),
                            "roles_id":RolEmpleado.value
                          },
                          Uri : 'ContratarEmpleado',
                          Method : 'POST',
                          CallBack:(res)=>{
                            if(res.code == -1 || res.code == 2){
                              alert(res.message);
                              return false;
                            }
                            RegistrarEmpleadoForm.reset();
                            location.reload();
                          }
                        }

                        if(SelectProfesion.value == -1){
                          ajax(
                            {
                              Uri:'Profesion',
                              Method:'POST',
                              Request:{
                                "api_token" : localStorage.token,
                                "profesion": OtraProfesionEmpleadoInput.value.toLowerCase()
                              },
                              CallBack: res => { // insertar nueva profesion
                                if(res.code == 1){
                                  const IdProfesion = res.data;
                                  req.Request.profesion_id = IdProfesion;
                                  ajax(req);
                                  return;
                                }
                                alert(res.message);
                              }
                            }
                          )

                        }else{ // seleccionar profesión existente
                          ajax(req);
                        }
                      }
                    }
                  );
                }
              }
            )
          }
        }
      );
    }

    document.querySelector('#EmpleadoSubmit').addEventListener('click', e => {
      RegistrarEmpleadoForm.onsubmit();
    });

  </script>

  <script type="text/javascript">
    $(document).ready(function () {
      $('#tabla').load('../../../app/api/tablaEmpleado.php?api_token=' + localStorage.token);
    });
  </script>
</body>

</html>
